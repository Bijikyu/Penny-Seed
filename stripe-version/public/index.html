<html>
    <head></head>

    <body>
        <a href="https://connect.stripe.com/express/oauth/authorize?redirect_uri=http://localhost:3000/create-account&client_id=ca_FJDPp6d0D27t8JqLtusK6JeYRSZPQMK8&suggested_capabilities[]=card_payments">
            <button id=createAnAccountButton>Create an Account</button>
        </a>

        <a href="/login">
            <button id=loginButton>Login</button>
        </a>

        <button disabled id=myAccountButton>My Account</button>

        <button id=createACampaignButton disabled>Create a Campaign</button>

        <div id=campaignsDiv>
            <template id=campaignTemplate>
                <form method="GET" style="border: solid">
                    Campaign #<div style="display: inline" class="campaign_index"></div>
                    <br>
                    Amount: $<div style="display: inline" class="amount"></div>
                    <br>
                    Deadline: <div style="display: inline" class="deadline"></div>
                    <br>
                    Max Pledge Amount: $<div style="display: inline" class="maxPledge"></div>
                    <br>
                    Pledgers: <div style="display: inline" class="pledgers"></div>
                    <br>
                    Current Pledge Amount: $<div style="display: inline" class="currentPledge"></div>
                    <br>
                    New Pledge Amount: $<div style="display: inline" class="newPledge"></div>
                    <br>
                    <button type="submit">Pledge</button>
                </form>
            </template>
        </div>

        <script>
            // check if logged in
            const params = (new URL(document.location)).searchParams;
            const stripe_user_id = params.get("stripe_user_id");
            if(typeof stripe_user_id == "string") {
                createAnAccountButton.disabled = true;
                loginButton.disabled = true;
                createACampaignButton.disabled = false;
                myAccountButton.disabled = false;

                createACampaignButton.addEventListener("click", event => {
                    window.location = `/create-campaign?stripe_user_id=${stripe_user_id}`;
                });

                myAccountButton.addEventListener("click", event => {
                    fetch(`/my-account?stripe_user_id=${stripe_user_id}`, {method:"POST"})
                        .then(response => response.json())
                        .then(link => window.location = link.url);
                });
            }
        </script>

        <script>
            // render campaigns
            fetch("/campaigns", {method : "POST"})
                .then(response => response.json())
                .then(campaigns => {
                    campaigns.forEach((campaign, campaign_index) => {
                        const documentFragment = document.importNode(campaignTemplate.content, true);
                        const minPledgers = Math.ceil(campaign.amount/campaign.maxPledge);
                        const form = documentFragment.querySelector("form");
                            form.querySelector(".campaign_index").innerText = campaign_index;
                            form.querySelector(".amount").innerText = campaign.amount;
                            form.querySelector(".deadline").innerText = campaign.deadline;
                            form.querySelector(".maxPledge").innerText = campaign.maxPledge;
                            form.querySelector(".pledgers").innerText = `${campaign.pledgers.length}/${minPledgers}`;
                            form.querySelector(".currentPledge").innerText = (campaign.pledgers.length <= minPledgers)? campaign.maxPledge : Math.floor(100*campaign.amount/campaign.pledgers.length)/100;
                            form.querySelector(".newPledge").innerText = (campaign.pledgers.length+1 <= minPledgers)? campaign.maxPledge : Math.floor(100*campaign.amount/(campaign.pledgers.length+1))/100;

                        const deadline = new Date(campaign.deadline);
                        if(Date.now() > deadline.getTime()) {
                            form.querySelector("button").disabled = true;
                            form.querySelector("button").innerText = (campaign.pledgers.length >= minPledgers)? "Successful" : "Failed";
                        }
                        
                        form.addEventListener("submit", event => {
                            event.preventDefault();
                            window.location = `./campaign?campaign_index=${campaign_index}`;
                        });

                        campaignsDiv.appendChild(form);
                    });
                });
        </script>
    </body>
</html>