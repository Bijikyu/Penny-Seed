<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="https://js.stripe.com/v3/"></script>
    </head>

    <body>
        <form method="POST" action="/pledge" style="border: solid">
            Campaign #<div style="display: inline" class="campaign_index"></div>
            <br>
            Amount: $<div style="display: inline" class="amount"></div>
            <br>
            Deadline: <div style="display: inline" class="deadline"></div>
            <br>
            Max Pledge Amount: $<div style="display: inline" class="maxPledge"></div>
            <br>
            Pledgers: <div style="display: inline" class="pledgers"></div>
            <br>
            Current Pledge Amount: $<div style="display: inline" class="currentPledge"></div>
            <br>
            New Pledge Amount: $<div style="display: inline" class="newPledge"></div>
            <br>
            <div class="card-element"></div>
            <input type="hidden" name="campaign_index" class="campaign_index">
            <input type="hidden" name="stripeToken" class="stripeToken">
            <button>Pledge</button>
        </form>
    </body>

    <script>
        const stripe = Stripe('pk_test_tf2jlu72HvCX7VNWbBpmaBnd00yvh5kpLZ');
        const elements = stripe.elements();

        const params = (new URL(document.location)).searchParams;
        const campaign_index = params.get("campaign_index");

        if(!isNaN(campaign_index)) {
            fetch("/campaigns", {method:"POST"})
                .then(response => response.json())
                .then(campaigns => {
                    console.log(campaigns)
                    const campaign = campaigns[campaign_index];
                    if(campaign !== undefined) {
                        const deadline = new Date(campaign.deadline);
                        const minPledgers = Math.ceil(campaign.amount/campaign.maxPledge);
                        const form = document.querySelector("form");
                            form.querySelector("input.campaign_index").value = campaign_index;
                            form.querySelector("div.campaign_index").innerText = campaign_index;
                            form.querySelector(".amount").innerText = campaign.amount;
                            form.querySelector(".deadline").innerText = campaign.deadline;
                            form.querySelector(".maxPledge").innerText = campaign.maxPledge;
                            form.querySelector(".pledgers").innerText = `${campaign.pledgers.length}/${minPledgers}`;
                            form.querySelector(".currentPledge").innerText = (campaign.pledgers.length <= minPledgers)? campaign.maxPledge : Math.floor(100*campaign.amount/campaign.pledgers.length)/100;
                            form.querySelector(".newPledge").innerText = (campaign.pledgers.length+1 <= minPledgers)? campaign.maxPledge : Math.floor(100*campaign.amount/(campaign.pledgers.length+1))/100;
                        
                        if(Date.now() < deadline.getTime()) {
                            const card = elements.create("card");
                                card.mount(form.querySelector(".card-element"));

                            form.addEventListener("submit", event => {
                                event.preventDefault();

                                stripe.createToken(card)
                                    .then(result => {
                                        if(result.error) {

                                        }
                                        else {
                                            form.querySelector(".stripeToken").value = result.token.id;
                                            form.submit();
                                        }
                                    });
                            });        
                        }
                        else {
                            form.querySelector("button").disabled = true;
                            form.querySelector("button").innerText = (campaign.pledgers.length >= minPledgers)? "Successful" : "Failed";
                        }
                    }
                });    
        }

    </script>
</html>